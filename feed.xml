<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en"><generator uri="https://jekyllrb.com/" version="4.4.1">Jekyll</generator><link href="https://lemuelpuglisi.github.io/feed.xml" rel="self" type="application/atom+xml"/><link href="https://lemuelpuglisi.github.io/" rel="alternate" type="text/html" hreflang="en"/><updated>2025-03-07T18:52:17+00:00</updated><id>https://lemuelpuglisi.github.io/feed.xml</id><title type="html">blank</title><subtitle>Lemuel Puglisi&apos;s Academic Website. </subtitle><entry><title type="html">A short guide on BrLP</title><link href="https://lemuelpuglisi.github.io/blog/2024/brlp/" rel="alternate" type="text/html" title="A short guide on BrLP"/><published>2024-12-20T15:09:00+00:00</published><updated>2024-12-20T15:09:00+00:00</updated><id>https://lemuelpuglisi.github.io/blog/2024/brlp</id><content type="html" xml:base="https://lemuelpuglisi.github.io/blog/2024/brlp/"><![CDATA[<p>BrLP (<a href="https://papers.miccai.org/miccai-2024/paper/0511_paper.pdf">paper</a>, <a href="https://github.com/LemuelPuglisi/BrLP">code</a>) is a diffusion-based spatiotemporal disease progression model capable of predicting how a 3D brain MRI will appear at a future target age, given one or more prior MRIs from a subject. In this guide, I will explain how to apply BrLP to your own MRI data using the open-source CLI application.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/brlp-post/brlp-easy.drawio.svg-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/brlp-post/brlp-easy.drawio.svg-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/brlp-post/brlp-easy.drawio.svg-1400.webp"/> <img src="/assets/img/brlp-post/brlp-easy.drawio.svg" class="img-fluid mt-3" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption">A simple overview of what BrLP can do.</div> <h3 id="installing-the-brlp-cli">Installing the BrLP CLI</h3> <p>Start by cloning the GitHub repository for BrLP:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone git@github.com:LemuelPuglisi/BrLP.git
</code></pre></div></div> <p>Next, navigate to the <code class="language-plaintext highlighter-rouge">BrLP</code> directory and install the <code class="language-plaintext highlighter-rouge">brlp</code> Python package using <code class="language-plaintext highlighter-rouge">pip</code>:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip install -e .
</code></pre></div></div> <p>This command will also install all required dependencies. Once completed, verify the installation by running:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>brlp --help
</code></pre></div></div> <p>If you encounter any issues, feel free to <a href="https://github.com/LemuelPuglisi/BrLP/issues">open an issue on GitHub</a>.</p> <p>At the end of this step, our file structure will be the following:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.
└── BrLP/
    └── ...
</code></pre></div></div> <h3 id="downloading-the-models">Downloading the models</h3> <p>Begin by creating a directory to store the pretrained models:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir models
</code></pre></div></div> <p>Next, download all the models listed in <a href="https://github.com/LemuelPuglisi/BrLP?tab=readme-ov-file#pretrained-models">the Pretrained Models section</a>. Make sure to unzip the auxiliary model archive (<code class="language-plaintext highlighter-rouge">aux-dcm.zip</code>) and place its contents into the <code class="language-plaintext highlighter-rouge">models</code> directory.</p> <p>At the end of this step, our file structure will be the following:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.
└── BrLP/
└── models/
    ├── autoencoder.pth
    ├── latentdiffusion.pth
    ├── controlnet.pth
    └── dcm-aux/
        ├── dcm_ad.json
        ├── dcm_mci.json
        └── dcm_nc.json
</code></pre></div></div> <h3 id="creating-the-brlp-configuration-file">Creating the BrLP configuration file</h3> <p>Copy the example configuration file to the root directory:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cp BrLP/examples/confs.example.yaml confs.yaml
</code></pre></div></div> <p>Open confs.yaml in a text editor and update the following fields: <code class="language-plaintext highlighter-rouge">autoencoder</code>, <code class="language-plaintext highlighter-rouge">unet</code> (refers to <code class="language-plaintext highlighter-rouge">diffusionmodel.pth</code>), <code class="language-plaintext highlighter-rouge">controlnet</code>, <code class="language-plaintext highlighter-rouge">aux</code> (cn, mci, ad). Specify the locations of the downloaded models <strong>using absolute paths</strong>!</p> <p>At the end of this step, our file structure will be the following:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.
├── BrLP/
├── models/
│   ├── autoencoder.pth
│   ├── latentdiffusion.pth
│   ├── controlnet.pth
│   └── dcm-aux/
│       ├── dcm_ad.json
│       ├── dcm_mci.json
│       └── dcm_nc.json
└── confs.yaml
</code></pre></div></div> <h3 id="preparing-your-own-data">Preparing your own data</h3> <p>To apply BrLP to your own T1-weighted (T1w) MRI stored as a NIfTI file, let’s assume the file is named <code class="language-plaintext highlighter-rouge">t1.nii.gz</code>. For reference, the image below shows a T1w MRI from the <a href="https://brain-development.org/ixi-dataset/">IXI dataset</a>:</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/brlp-post/raw-t1-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/brlp-post/raw-t1-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/brlp-post/raw-t1-1400.webp"/> <img src="/assets/img/brlp-post/raw-t1.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <p>Since BrLP operates in the MNI152 space, you will need the MNI152 template. Download it from <a href="https://github.com/Washington-University/HCPpipelines/blob/master/global/templates/MNI152_T1_1mm_brain.nii.gz">this link</a>. Rename the downloaded template to <code class="language-plaintext highlighter-rouge">mni152.nii.gz</code> for simplicity.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/brlp-post/mni-template-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/brlp-post/mni-template-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/brlp-post/mni-template-1400.webp"/> <img src="/assets/img/brlp-post/mni-template.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <p>Place both <code class="language-plaintext highlighter-rouge">t1.nii.gz</code> and <code class="language-plaintext highlighter-rouge">mni152.nii.gz</code> in the root directory of your workspace. After completing this step, your file structure should look like this:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.
├── BrLP/
├── models/
├── confs.yaml
├── t1.nii.gz
└── mni152.nii.gz
</code></pre></div></div> <h3 id="preprocessing-the-mri">Preprocessing the MRI</h3> <p>All the MRIs used for the BrLP study have been preprocessed using the <code class="language-plaintext highlighter-rouge">turboprep</code> pipeline (<a href="https://github.com/LemuelPuglisi/turboprep">github</a>), which is available via <code class="language-plaintext highlighter-rouge">Docker</code>. Start by <a href="https://docs.docker.com/engine/install/">installing Docker</a>. Then download the <code class="language-plaintext highlighter-rouge">turboprep-docker</code> script:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget https://raw.githubusercontent.com/LemuelPuglisi/turboprep/refs/heads/main/turboprep-docker
</code></pre></div></div> <p>Make it executable:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chmod a+x turboprep-docker  
</code></pre></div></div> <p>Create a folder where to store the outputs:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir outputs
</code></pre></div></div> <p>Finally run the script:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./turboprep-docker t1.nii.gz outputs mni152.nii.gz  
</code></pre></div></div> <p>At the end of this step, our file structure will be the following:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.
├── BrLP/
├── models/
├── outputs/
│   ├── affine_transf.mat  
│   ├── mask.nii.gz  
│   ├── normalized.nii.gz  
│   └── segm.nii.gz
├── turboprep-docker
├── confs.yaml
├── t1.nii.gz
└── mni152.nii.gz
</code></pre></div></div> <p>We are interested in two files: (1) <code class="language-plaintext highlighter-rouge">normalized.nii.gz</code> is the aligned, skull-stripped and intensity-normalized input image:</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/brlp-post/preprocessed-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/brlp-post/preprocessed-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/brlp-post/preprocessed-1400.webp"/> <img src="/assets/img/brlp-post/preprocessed.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <p>and (2) its segmentation (obtained using <a href="https://surfer.nmr.mgh.harvard.edu/fswiki/SynthSeg">SynthSeg</a>):</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/brlp-post/synthseg-segm-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/brlp-post/synthseg-segm-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/brlp-post/synthseg-segm-1400.webp"/> <img src="/assets/img/brlp-post/synthseg-segm.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <h3 id="creating-the-input-csv-for-brlp">Creating the Input CSV for BrLP</h3> <p>BrLP can utilize multiple MRIs from the same subject, taken at different ages, to improve its predictive performance. All MRIs must be preprocessed as described in the previous section. Additionally, the details of these MRIs—such as the subject’s age at acquisition, the unique image identifier, and the file paths—must be listed in a CSV file called <code class="language-plaintext highlighter-rouge">inputs.csv</code>.</p> <p>The CSV file should have the following five header columns:</p> <ul> <li><strong><code class="language-plaintext highlighter-rouge">image_uid</code> (string)</strong>: A unique identifier for each MRI (this can be arbitrary).</li> <li><strong><code class="language-plaintext highlighter-rouge">age</code> (integer)</strong>: The subject’s age at the time of MRI acquisition.</li> <li><strong><code class="language-plaintext highlighter-rouge">sex</code> (integer)</strong>: Use <code class="language-plaintext highlighter-rouge">1</code> for male and <code class="language-plaintext highlighter-rouge">2</code> for female.</li> <li><strong><code class="language-plaintext highlighter-rouge">image_path</code> (string)</strong>: The absolute path to the preprocessed MRI image (e.g., <code class="language-plaintext highlighter-rouge">outputs/normalized.nii.gz</code>).</li> <li><strong><code class="language-plaintext highlighter-rouge">segm_path</code> (string)</strong>: The absolute path to the corresponding segmentation file (e.g., <code class="language-plaintext highlighter-rouge">outputs/segm.nii.gz</code>).</li> </ul> <p>Here’s an example of how the <code class="language-plaintext highlighter-rouge">inputs.csv</code> file might look for a single MRI:</p> <pre><code class="language-csv">image_uid,age,sex,image_path,segm_path  
image_1,29,1,/absolute/path/to/outputs/normalized.nii.gz,/absolute/path/to/outputs/segm.nii.gz  
</code></pre> <p>After creating this file, your workspace structure will be as follows:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.  
├── BrLP/  
├── models/  
├── outputs/  
├── turboprep-docker  
├── inputs.csv  
├── confs.yaml  
├── t1.nii.gz  
└── mni152.nii.gz  
</code></pre></div></div> <h3 id="running-brlp">Running BrLP</h3> <p>First, create a directory to store the predictions:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir </span>predictions  
</code></pre></div></div> <p>In our example, our input MRI is from a 29 years old male subject, and we want to simulate the progression of this subject up to 80 years old, assuming he has Alzheimer’s Disease (AD). To do this, set the following parameters:</p> <ul> <li><code class="language-plaintext highlighter-rouge">--target_diagnosis 3</code> (where <code class="language-plaintext highlighter-rouge">1</code> = healthy, <code class="language-plaintext highlighter-rouge">2</code> = mild cognitive impairment, <code class="language-plaintext highlighter-rouge">3</code> = Alzheimer’s Disease)</li> <li><code class="language-plaintext highlighter-rouge">--target_age 80</code></li> <li><code class="language-plaintext highlighter-rouge">--steps 10</code> (to generate intermediate MRIs in 10 steps between age 29 and 80)</li> </ul> <p>Now, you can run the <code class="language-plaintext highlighter-rouge">brlp</code> command to generate the predicted MRIs:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>brlp    <span class="nt">--input</span> inputs.csv <span class="se">\ </span> 
        <span class="nt">--output</span> predictions <span class="se">\ </span> 
        <span class="nt">--confs</span> confs.yaml <span class="se">\ </span> 
        <span class="nt">--target_age</span> 80 <span class="se">\ </span> 
        <span class="nt">--target_diagnosis</span> 3 <span class="se">\ </span> 
        <span class="nt">--steps</span> 10
</code></pre></div></div> <p>After running this command, the predicted MRIs will be saved in the <code class="language-plaintext highlighter-rouge">predictions</code> folder. You can visualize the predictions using an MRI viewer such as FSLeyes. Below are some example results from running the command:</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/brlp-post/pred-47-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/brlp-post/pred-47-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/brlp-post/pred-47-1400.webp"/> <img src="/assets/img/brlp-post/pred-47.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption">Prediction at age 47 (ageing + Alzheimer's Disease)</div> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/brlp-post/pred-63-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/brlp-post/pred-63-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/brlp-post/pred-63-1400.webp"/> <img src="/assets/img/brlp-post/pred-63.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption">Prediction at age 63 (ageing + Alzheimer's Disease)</div> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/brlp-post/pred-74-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/brlp-post/pred-74-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/brlp-post/pred-74-1400.webp"/> <img src="/assets/img/brlp-post/pred-74.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption">Prediction at age 74 (ageing + Alzheimer's Disease)</div> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/brlp-post/pred-80-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/brlp-post/pred-80-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/brlp-post/pred-80-1400.webp"/> <img src="/assets/img/brlp-post/pred-80.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption">Prediction at age 80 (ageing + Alzheimer's Disease)</div>]]></content><author><name></name></author><category term="research"/><category term="disease-progression"/><category term="BrLP"/><category term="medical-imaging"/><summary type="html"><![CDATA[How to simulate ageing and disease progression? A short guide on how to use BrLP.]]></summary></entry></feed>