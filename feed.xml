<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en"><generator uri="https://jekyllrb.com/" version="4.3.4">Jekyll</generator><link href="https://lemuelpuglisi.github.io/feed.xml" rel="self" type="application/atom+xml"/><link href="https://lemuelpuglisi.github.io/" rel="alternate" type="text/html" hreflang="en"/><updated>2024-12-22T18:26:16+00:00</updated><id>https://lemuelpuglisi.github.io/feed.xml</id><title type="html">blank</title><subtitle>Lemuel Puglisi&apos;s Academic Website. </subtitle><entry><title type="html">A short guide on BrLP</title><link href="https://lemuelpuglisi.github.io/blog/2024/brlp/" rel="alternate" type="text/html" title="A short guide on BrLP"/><published>2024-12-20T15:09:00+00:00</published><updated>2024-12-20T15:09:00+00:00</updated><id>https://lemuelpuglisi.github.io/blog/2024/brlp</id><content type="html" xml:base="https://lemuelpuglisi.github.io/blog/2024/brlp/"><![CDATA[<p>This guide assumes you’re familiar with BrLP (<a href="https://papers.miccai.org/miccai-2024/paper/0511_paper.pdf">paper</a>, <a href="https://github.com/LemuelPuglisi/BrLP">code</a>). I will explain how to use the BrLP CLI application to infer the disease progression and ageing process on your own T1-weighted (T1w) MRIs.</p> <h3 id="installing-brlp">Installing BrLP</h3> <p>First, clone the GitHub repository of BrLP:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone git@github.com:LemuelPuglisi/BrLP.git
</code></pre></div></div> <p>Then, access the <code class="language-plaintext highlighter-rouge">BrLP</code> directory and install the <code class="language-plaintext highlighter-rouge">brlp</code> python package using pip:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip install -e .
</code></pre></div></div> <p>This will also install all the required dependencies. You should be able to run this command:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>brlp --help
</code></pre></div></div> <p>If not, <a href="https://github.com/LemuelPuglisi/BrLP/issues">please open an issue on GitHub</a>.</p> <p>At the end of this step, our file structure will be the following:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.
└── BrLP/
    └── ...
</code></pre></div></div> <h3 id="downloading-the-models">Downloading the models</h3> <p>Create a <code class="language-plaintext highlighter-rouge">models</code> directory:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir models
</code></pre></div></div> <p>Download all the models from <a href="https://github.com/LemuelPuglisi/BrLP?tab=readme-ov-file#pretrained-models">the Pretrained Models section</a>. Remember Unzip the auxiliary model (<code class="language-plaintext highlighter-rouge">aux-dcm.zip</code>). Put everything inside the <code class="language-plaintext highlighter-rouge">models</code> directory.</p> <p>At the end of this step, our file structure will be the following:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.
└── BrLP/
└── models/
    ├── autoencoder.pth
    ├── latentdiffusion.pth
    ├── controlnet.pth
    └── dcm-aux/
        ├── dcm_ad.json
        ├── dcm_mci.json
        └── dcm_nc.json
</code></pre></div></div> <h3 id="create-the-brlp-configuration-file">Create the BrLP configuration file</h3> <p>Copy the example configuration file</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cp BrLP/examples/confs.example.yaml confs.yaml
</code></pre></div></div> <p>Edit the fields <code class="language-plaintext highlighter-rouge">autoencoder</code>, <code class="language-plaintext highlighter-rouge">unet</code>, <code class="language-plaintext highlighter-rouge">controlnet</code>, <code class="language-plaintext highlighter-rouge">aux</code> (cn, mci, ad) and specify the locations of the downloaded models <strong>using absolute paths</strong>!</p> <p>At the end of this step, our file structure will be the following:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.
├── BrLP/
├── models/
│   ├── autoencoder.pth
│   ├── latentdiffusion.pth
│   ├── controlnet.pth
│   └── dcm-aux/
│       ├── dcm_ad.json
│       ├── dcm_mci.json
│       └── dcm_nc.json
└── confs.yaml
</code></pre></div></div> <h3 id="prepare-your-own-data">Prepare your own data</h3> <p>Suppose you want to apply BrLP to your own T1w MRI, stored as a nifti file <code class="language-plaintext highlighter-rouge">t1.nii.gz</code>. For reference, this is a T1w MRI from the <a href="https://brain-development.org/ixi-dataset/">IXI dataset</a>:</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/brlp-post/raw-t1-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/brlp-post/raw-t1-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/brlp-post/raw-t1-1400.webp"/> <img src="/assets/img/brlp-post/raw-t1.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <p>BrLP works on the MNI152 space, so you also need to download the following template from <a href="https://github.com/Washington-University/HCPpipelines/blob/master/global/templates/MNI152_T1_1mm_brain.nii.gz">here</a>. Suppose we rename the template file as <code class="language-plaintext highlighter-rouge">mni152.nii.gz</code>.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/brlp-post/mni-template-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/brlp-post/mni-template-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/brlp-post/mni-template-1400.webp"/> <img src="/assets/img/brlp-post/mni-template.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <p>Let’s put these two files at the root of our workspace. At the end of this step, our file structure will be the following:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.
├── BrLP/
├── models/
├── confs.yaml
├── t1.nii.gz
└── mni152.nii.gz
</code></pre></div></div> <h3 id="preprocessing-the-mri">Preprocessing the MRI</h3> <p>All the MRIs used for the BrLP study have been preprocessed using the <code class="language-plaintext highlighter-rouge">turboprep</code> pipeline (<a href="https://github.com/LemuelPuglisi/turboprep">github</a>), which is available via <code class="language-plaintext highlighter-rouge">Docker</code>. Start by <a href="https://docs.docker.com/engine/install/">installing Docker</a>. Then download the <code class="language-plaintext highlighter-rouge">turboprep-docker</code> script:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget https://raw.githubusercontent.com/LemuelPuglisi/turboprep/refs/heads/main/turboprep-docker
</code></pre></div></div> <p>Make it executable:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chmod a+x turboprep-docker  
</code></pre></div></div> <p>Create a folder where to store the outputs:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir outputs
</code></pre></div></div> <p>Finally run the script:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./turboprep-docker t1.nii.gz outputs mni152.nii.gz  
</code></pre></div></div> <p>At the end of this step, our file structure will be the following:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.
├── BrLP/
├── models/
├── outputs/
│   ├── affine_transf.mat  
│   ├── mask.nii.gz  
│   ├── normalized.nii.gz  
│   └── segm.nii.gz
├── confs.yaml
├── t1.nii.gz
└── mni152.nii.gz
</code></pre></div></div> <p>We are interested in two files: (1) <code class="language-plaintext highlighter-rouge">normalized.nii.gz</code> is the aligned, skull-stripped and intensity-normalized input image:</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/brlp-post/preprocessed-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/brlp-post/preprocessed-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/brlp-post/preprocessed-1400.webp"/> <img src="/assets/img/brlp-post/preprocessed.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <p>and (2) its segmentation (obtained using <a href="https://surfer.nmr.mgh.harvard.edu/fswiki/SynthSeg">SynthSeg</a>):</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/brlp-post/synthseg-segm-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/brlp-post/synthseg-segm-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/brlp-post/synthseg-segm-1400.webp"/> <img src="/assets/img/brlp-post/synthseg-segm.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <h3 id="creating-the-input-csv-for-brlp">Creating the Input CSV for BrLP</h3> <p>BrLP can utilize multiple MRIs from the same subject, taken at different ages, to enhance its predictive capabilities. All available MRIs should be preprocessed as described in the previous section. Their details—such as the subject’s age at acquisition, the unique image identifier, and file paths—must be listed in a CSV file <code class="language-plaintext highlighter-rouge">inputs.csv</code>.</p> <p>The CSV file should include the following 5 header columns:</p> <ul> <li><strong><code class="language-plaintext highlighter-rouge">image_uid</code> (string)</strong>: A unique identifier for each MRI (arbitrary).</li> <li><strong><code class="language-plaintext highlighter-rouge">age</code> (integer)</strong>: The subject’s age at the time of MRI acquisition.</li> <li><strong><code class="language-plaintext highlighter-rouge">sex</code> (integer)</strong>: Use <code class="language-plaintext highlighter-rouge">1</code> for male and <code class="language-plaintext highlighter-rouge">2</code> for female.</li> <li><strong><code class="language-plaintext highlighter-rouge">image_path</code> (string)</strong>: The absolute path to the preprocessed image (e.g., <code class="language-plaintext highlighter-rouge">outputs/normalized.nii.gz</code>).</li> <li><strong><code class="language-plaintext highlighter-rouge">segm_path</code> (string)</strong>: The absolute path to the corresponding segmentation file (e.g., <code class="language-plaintext highlighter-rouge">outputs/segm.nii.gz</code>).</li> </ul> <p>Here’s an example of how the <code class="language-plaintext highlighter-rouge">input.csv</code> might look for a single MRI:</p> <pre><code class="language-csv">image_uid,age,sex,image_path,segm_path  
image_1,29,1,/absolute/path/to/outputs/normalized.nii.gz,/absolute/path/to/outputs/segm.nii.gz  
</code></pre> <p>At the end of this step, our file structure will be the following:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.
├── BrLP/
├── models/
├── outputs/
├── inputs.csv
├── confs.yaml
├── t1.nii.gz
└── mni152.nii.gz
</code></pre></div></div> <h3 id="running-brlp">Running BrLP</h3> <p>Create a directory where to store the predictions:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir predictions
</code></pre></div></div> <p>Now you are ready to run the <code class="language-plaintext highlighter-rouge">brlp</code> command:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>brlp    --input inputs.csv \
        --output predictions \
        --confs confs.yaml \
        --target_age 80 \
        --target_diagnosis 2 \
        --steps 5 \
        --threads 4
</code></pre></div></div> <p>Visualize the predictions using an MRI viewer (e.g., <code class="language-plaintext highlighter-rouge">fsleyes</code>).</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/brlp-post/pred-55-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/brlp-post/pred-55-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/brlp-post/pred-55-1400.webp"/> <img src="/assets/img/brlp-post/pred-55.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption">Prediction at age 55</div> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/brlp-post/pred-68-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/brlp-post/pred-68-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/brlp-post/pred-68-1400.webp"/> <img src="/assets/img/brlp-post/pred-68.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption">Prediction at age 68</div> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/brlp-post/pred-80-480.webp"/> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/brlp-post/pred-80-800.webp"/> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/brlp-post/pred-80-1400.webp"/> <img src="/assets/img/brlp-post/pred-80.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption">Prediction at age 80</div> <p>At the end of this step, our file structure will be the following:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.
├── BrLP/
├── models/
├── outputs/
├── predictions/
├── inputs.csv
├── confs.yaml
├── t1.nii.gz
└── mni152.nii.gz
</code></pre></div></div>]]></content><author><name></name></author><category term="research"/><category term="disease-progression"/><category term="BrLP"/><category term="medical-imaging"/><summary type="html"><![CDATA[How to simulate ageing and disease progression? A short guide on how to use BrLP.]]></summary></entry></feed>